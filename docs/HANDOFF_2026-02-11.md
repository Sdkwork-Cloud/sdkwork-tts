# Handoff Notes - February 11, 2026

This file is for continuation by another model/engineer without losing context.

## User objective

Get IndexTTS2-Rust to produce clear speech (not rumbling water), ensure emotion methods and voice cloning work, and provide easy launch UX.

## Repository state highlights

- Branch: `main`
- Remote: `origin https://github.com/DevMan57/indextts2-rust.git`
- There are many modified tracked files from today in core model/inference paths.
- There are many untracked debug artifact directories under `debug/` and swarm upload folders.

## Upstream verification

Local Python reference clone at `C:\AI\index-tts` matches current GitHub `main` HEAD:

- Commit: `1698b32033f38a034572891aed698609da2ff392`

Checked against upstream behavior:

- GPT uses dedicated final norm before mel head.
- BigVGAN uses direct `ConvTranspose1d` upsampling and no extra fixed Snake pre-upsample.
- Emotion vector logic (bias, cap, vector mixing) matches `infer_v2.py` flow.

## Major fixes now present in Rust code

1. GPT logits path normalization fix
- Separate LM-head norm loaded from `final_norm.*`.
- Applied before mel projection in decode path.

2. GPT parity instrumentation
- Step1 and last-step logits dump plus cache-length-per-step in Rust.
- Python comparer extended for cached replay parity against those dumps.

3. DiT parity upgrades
- RMSNorm Ada behavior, RoPE, UViT skip schedule, adaptive final norm.

4. BigVGAN rumble fix
- Replaced approximate transposed conv path with true transposed conv.
- Removed non-upstream extra scalar Snake pre-upsample.

5. Post-vocoder guardrail
- Added de-rumble high-pass flag and automatic fallback for severe DC bias.

## Validation completed in this session

### Build validation

```powershell
$env:CUDA_COMPUTE_CAP='90'
cargo check --release --features cuda
```

Result: pass (non-blocking missing-doc warnings in `src/models/emotion/controls.rs` before this handoff update).

### Mode validation (voice + emotion)

Generated by executable runs in:

- `debug/validation_suite_20260211/voice_clone.wav`
- `debug/validation_suite_20260211/emotion_audio.wav`
- `debug/validation_suite_20260211/emotion_audio_blend.wav`
- `debug/validation_suite_20260211/emotion_vector.wav`
- `debug/validation_suite_20260211/emotion_text.wav`

All 5 runs succeeded and produced audio.

### Quality sweep

Generated in `debug/quality_sweep_20260211/` with metrics in `metrics_report.json`.

Candidate configs:

- `cfg_a_safe` (`top-k=0`, `top-p=1.0`, `temp=0.8`, `rep=1.05`, `cutoff=180`)
- `cfg_b_balanced` (`top-k=20`, `top-p=0.92`, `temp=0.75`, `rep=1.10`, `cutoff=180`)
- `cfg_c_defaultish` (`top-k=50`, `top-p=0.95`, `temp=0.8`, `rep=1.10`, `cutoff=180`)
- `cfg_d_lowtemp` (`top-k=0`, `top-p=1.0`, `temp=0.70`, `rep=1.15`, `cutoff=160`)
- `cfg_e_hicut` (`top-k=0`, `top-p=1.0`, `temp=0.85`, `rep=1.00`, `cutoff=200`)

Practical recommended default remains `cfg_a_safe` until further listening/AB testing.

## Easy launcher/UI added

- `launch_indextts2.ps1`
- `launch_ui.ps1`
- `scripts/ui_launcher.py`

UI is local Tkinter (no extra pip deps), builds/runs CLI and supports all modes.

## Highest-value remaining task

### GPT cached decode divergence after step0

Current parity state:

- Step0 logits close.
- Step1 and later still drift.
- Cache length growth matches exactly.

Next isolation task:

1. Dump/compare step1 internals from Rust vs Python:
   - pre/post layer norm
   - q/k/v projections
   - attention scores (pre/post mask/scale)
2. Identify the first tensor with large error and patch logic there.
3. Re-run long-sequence parity sweep and then regenerate listening clips.

## Suggested continuation command set

```powershell
# 1) Build
$env:CUDA_COMPUTE_CAP='90'
cargo check --release --features cuda

# 2) Launch GUI quickly
./launch_ui.ps1

# 3) Run parity comparer
python scripts/parity_compare.py --dump-dir debug/parity_next

# 4) Run quality sweep metrics
python scripts/audio_metrics.py --dir debug/quality_sweep_20260211
```

## Notes on noisy logs

Core model paths still include verbose `eprintln!` debug output. They are useful for parity work but noisy for normal users. Keep while debugging parity; remove/reduce once parity closes.
